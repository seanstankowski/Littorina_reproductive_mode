######## Filter VCF file

#----- move vcfs for each batch of contigs into 1 directory

## copies all vcfs in from n subdirectories into a single new directory
find . -name '*.combined.vcf.gz' -exec mv {} /fastdata/bo1srs/Take_4_VCFs \;


#----- combine the VCFs from all batches of contigs called separately 
/data/bo1srs/bcftools_dir/bcftools/bcftools concat --file-list /fastdata/bo1srs/Take_4_VCFs/vcf_list.txt --output /fastdata/bo1srs/Take_4_VCFs/concat_108.vcf.gz --output-type z 


#----- hard filtering in BCFtools
/data/bo1srs/bcftools_dir/bcftools/bcftools filter -e 'FS>60.0 || SOR>3 || MQ<40 || MQRankSum<-12.5 || QD<2.0 || ReadPosRankSum<-8.0' -O z -o /fastdata/bo1srs/Take_4_VCFs/HardFilter_concat_108.vcf.gz --threads 16 /fastdata/bo1srs/Take_4_VCFs/concat_108.vcf.gz


#----- remove SNPs within 5 bp of an indel/complex polymorphism; these tend to be problematic caused by realignment problems
/data/bo1srs/bcftools-1.15/bcftools filter -g 5:indel,other /fastdata/bo1srs/Take_4_VCFs/HardFilter_concat_108.vcf.gz -o /fastdata/bo1srs/Take_4_VCFs/SNPgap5_HardFilter_concat_108.vcf.gz --output-type z --threads 16


#----- remove indels and mult-allelic snps
/data/bo1srs/bcftools-1.15/bcftools --exclude-types indels,other --max-alleles 2 --output-type z -o /fastdata/bo1srs/Take_4_VCFs/ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz /fastdata/bo1srs/Take_4_VCFs/SNPgap5_HardFilter_concat_108.vcf.gz


#----- drop sites where average read depth is high 
/data/bo1srs/bcftools-1.15/bcftools  filter -e 'INFO/DP>4320' --output-type z --threads 16 -o /fastdata/bo1srs/Take_4_VCFs/MaxDP_ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz /fastdata/bo1srs/Take_4_VCFs/ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz 


#----- initial filtering of genotypes for depth and quality to make the file a bit more manageable 
/data/bo1srs/bcftools-1.15/bcftools filter -S . 
-e 'FMT/DP<5 | FMT/GQ<20' -O z -o /fastdata/bo1srs/Take_4_VCFs/Softfilters_MaxDP_ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz /fastdata/bo1srs/Take_4_VCFs/MaxDP_ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz --threads 16


#----- drop sites with > 20% missing data 
/data/bo1srs/bcftools-1.15/bcftools filter -e 'F_MISSING > 0.2' -O z -o MaxMiss0.2_Softfilters_MaxDP_ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz Softfilters_MaxDP_ExcludeIndelsOtherMulti_SNPgap5_HardFilters_concat_108.vcf.gz


#----- after looking at the depth distributions drop all sites with < 1500 total reads...

/data/bo1srs/bcftools-1.15/bcftools  filter -e 'INFO/DP<1500' --output-type z --threads 16 -o  minDP1500_all_sites_108_littorina.vcf.gz  all_sites_108_littorina.vcf.gz 


#----- ... and set genotypes with less < 10 reads to missing

/data/bo1srs/bcftools-1.15/bcftools filter -S . -e 'FMT/DP<10' -O z -o /fastdata/bo1srs/final_working_VCFs/softDP10_minDP1500_all_sites_108_littorina.vcf.gz /fastdata/bo1srs/final_working_VCFs/minDP1500_all_sites_108_littorina.vcf.gz --threads 16


#----- finally, drop all sites with > 10% missing data 

/data/bo1srs/bcftools-1.15/bcftools filter -e 'F_MISSING > 0.1' -O z --threads 16 -o /fastdata/bo1srs/final_working_VCFs/Maxmiss0.1_softDP10_minDP1500_all_sites_108_littorina.vcf.gz /fastdata/bo1srs/final_working_VCFs/softDP10_minDP1500_all_sites_108_littorina.vcf.gz 


################################## more precise filtering for contigs 1808 and 3201 to leave in indels


###Starting with the results of the hardfilters 

#----- pull out regions of interest

/data/bo1srs/bcftools-1.15/bcftools view /fastdata/bo1srs/final_working_VCFs/sweep_contigs/SNPgap5_HardFilter_concat_108.vcf.gz --regions Contig1808:5000-22000 --min-alleles 2 --output-type z -o /mnt/fastdata/bo1srs/final_working_VCFs/sweep_contigs/1808_minall2.vcf.gz
/data/bo1srs/bcftools-1.15/bcftools view /fastdata/bo1srs/final_working_VCFs/sweep_contigs/SNPgap5_HardFilter_concat_108.vcf.gz --regions Contig3201:48000-70000 --min-alleles 2 --output-type z -o /mnt/fastdata/bo1srs/final_working_VCFs/sweep_contigs/3201_minall2.vcf.gz

#----- drop sites where average read depth is high 

/data/bo1srs/bcftools-1.15/bcftools  filter -e 'INFO/DP>4320 | INFO/DP<1500' --output-type z --threads 16 -o /mnt/fastdata/bo1srs/final_working_VCFs/sweep_contigs/1808_MinMax_DP.vcf.gz /mnt/fastdata/bo1srs/final_working_VCFs/sweep_contigs/1808_minall2.vcf.gz 
/data/bo1srs/bcftools-1.15/bcftools  filter -e 'INFO/DP>4320 | INFO/DP<1500' --output-type z --threads 16 -o /mnt/fastdata/bo1srs/final_working_VCFs/sweep_contigs/3201_MinMax_DP.vcf.gz /mnt/fastdata/bo1srs/final_working_VCFs/sweep_contigs/3201_minall2.vcf.gz 

#----- ... and set genotypes with less < 10 reads to missing

/data/bo1srs/bcftools-1.15/bcftools filter -S . -e 'FMT/DP<10' -O z -o /fastdata/bo1srs/final_working_VCFs/sweep_contigs/1808_softDP10.vcf.gz /fastdata/bo1srs/final_working_VCFs/sweep_contigs/1808_minall2.vcf.gz
/data/bo1srs/bcftools-1.15/bcftools filter -S . -e 'FMT/DP<10' -O z -o /fastdata/bo1srs/final_working_VCFs/sweep_contigs/3201_softDP10.vcf.gz /fastdata/bo1srs/final_working_VCFs/sweep_contigs/3201_minall2.vcf.gz

#----- finally, drop all sites with > 10% missing data 

/data/bo1srs/bcftools-1.15/bcftools filter -e 'F_MISSING > 0.1' -O z --threads 16 -o /fastdata/bo1srs/final_working_VCFs/sweep_contigs/1808_Maxmiss0.1_softDP10_vcf.gz /fastdata/bo1srs/final_working_VCFs/sweep_contigs/1808_softDP10.vcf.gz
/data/bo1srs/bcftools-1.15/bcftools filter -e 'F_MISSING > 0.1' -O z --threads 16 -o /fastdata/bo1srs/final_working_VCFs/sweep_contigs/3201_Maxmiss0.1_softDP10_vcf.gz /fastdata/bo1srs/final_working_VCFs/sweep_contigs/3201_softDP10.vcf.gz

#----- output in --012 format
vcftools --gzvcf 3201_Maxmiss0.1_softDP10_vcf.gz --out 3201 --012 
vcftools --gzvcf 1808_Maxmiss0.1_softDP10_vcf.gz --out 1808 --012 

#----- output indels only
/data/bo1srs/bcftools-1.15/bcftools view --exclude-types snps --output-type z -o /fastdata/bo1srs/final_working_VCFs/sweep_contigs/indels_3201_Maxmiss0.1_softDP10_vcf.gz /fastdata/bo1srs/final_working_VCFs/sweep_contigs/3201_Maxmiss0.1_softDP10_vcf.gz
/data/bo1srs/bcftools-1.15/bcftools view --exclude-types snps --output-type z -o /fastdata/bo1srs/final_working_VCFs/sweep_contigs/indels_1808_Maxmiss0.1_softDP10_vcf.gz /fastdata/bo1srs/final_working_VCFs/sweep_contigs/1808_Maxmiss0.1_softDP10_vcf.gz


#### sympatric twisst

/nfs/scistore18/bartogrp/sstankow/TopologyWeightingFiles/snail_VCFs/sympatric_samples_SNPsonly.vcf.gz



# SN    [2]id   [3]key  [4]value
SN      0       number of samples:      35
SN      0       number of records:      10154989
SN      0       number of no-ALTs:      0
SN      0       number of SNPs: 10154655
SN      0       number of MNPs: 0
SN      0       number of indels:       0
SN      0       number of others:       0
SN      0       number of multiallelic sites:   0
SN      0       number of multiallelic SNP sites:       0
# TSTV, transitions/transversions:

/nfs/scistore18/bartogrp/sstankow/TopologyWeightingFiles/twisstScrips_newData


#/data/bo1srs/bcftools_dir/bcftools/bcftools view -S /nfs/scistore18/bartogrp/sstankow/TopologyWeightingFiles/snail_VCFs/sympatric_samples.txt -o /nfs/scistore18/bartogrp/sstankow/TopologyWeightingFiles/sympatric_samples.vcf.gz --threads 4 --output-type z PHASED_variants_only_Maxmiss0.1_softDP10_minDP1500_all_sites_108_littorina.vcf.gz.vcf.gz


/fastdata/bo1srs/twisst/sympatric_samples_SNPsonly.vcf.gz


/data/bo1srs/phyml-3.3.20211231/src/phyml
